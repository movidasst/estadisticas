<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de Accidentalidad - La Movida de SST</title>
    
    <!-- METADATOS REDES SOCIALES -->
    <meta property="og:title" content="Estadísticas de Accidentalidad - La Movida de SST">
    <meta property="og:description" content="Dashboard de Gestión SST bajo Norma COVENIN 474.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.movidasst.com">
    <meta property="og:image" content="https://assets.poap.xyz/ae80dd44-a4b8-4a90-9d76-2da198a1f6fc.png">
    
    <!-- REACT & LIBRERIAS -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- CORRECCIÓN: Usando CDNJS que es más estable para SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.875rem; transition: all 0.2s; }
        .input-field:focus { border-color: #00b050; outline: none; box-shadow: 0 0 0 3px rgba(0, 176, 80, 0.2); }
        .label-text { display: block; font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 0.25rem; text-transform: uppercase; }
        .header-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; transition: all 0.2s; cursor: pointer; white-space: nowrap; }
        .btn-action { background-color: #ffffff; color: #475569; border: 1px solid #e2e8f0; }
        .btn-action:hover { background-color: #f8fafc; color: #1e293b; border-color: #cbd5e1; }
        .btn-primary-action { background-color: #00b050; color: white; border: 1px solid #00b050; }
        .btn-primary-action:hover { background-color: #008a3e; }
        .btn-danger-action { color: #ef4444; background-color: #fff; border: 1px solid #fecaca; }
        .btn-danger-action:hover { background-color: #fef2f2; color: #dc2626; }
        .btn-help-action { color: #6366f1; background-color: #e0e7ff; border: 1px solid #c7d2fe; }
        .btn-help-action:hover { background-color: #c7d2fe; color: #4338ca; }
        .btn-warn-action { color: #d97706; background-color: #fff; border: 1px solid #fde68a; }
        .btn-warn-action:hover { background-color: #fffbeb; color: #b45309; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 500px; width: 90%; text-align: left; max-height: 90vh; overflow-y: auto; }
        .help-step { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .help-number { background-color: #00b050; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 0.75rem; margin-top: 2px; }

        @media print { .no-print { display: none !important; } body { background: white; } .shadow-sm { box-shadow: none !important; } .border { border: 1px solid #ddd !important; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;
        const { jsPDF } = window.jspdf;

        // --- CONSTANTES ---
        const BRAND_COLOR = '#00b050'; 
        const NEUTRAL_COLOR = '#334155';
        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const VENEZUELA_STATES = ['Amazonas', 'Anzoátegui', 'Apure', 'Aragua', 'Barinas', 'Bolívar', 'Carabobo', 'Cojedes', 'Delta Amacuro', 'Distrito Capital', 'Falcón', 'Guárico', 'La Guaira', 'Lara', 'Mérida', 'Miranda', 'Monagas', 'Nueva Esparta', 'Portuguesa', 'Sucre', 'Táchira', 'Trujillo', 'Yaracuy', 'Zulia', 'Dependencias Federales'];
        const INITIAL_DEPARTMENTS = ['Producción', 'Mantenimiento', 'Logística', 'Administración', 'Ventas', 'Seguridad', 'Obras'];
        const INITIAL_BRANCHES = [{ id: 'b1', name: 'Sede Principal', state: 'Distrito Capital' }];
        
        // ESTADO INICIAL FORMULARIO
        const INITIAL_FORM = { 
            month: 'Enero', year: new Date().getFullYear(), department: '', branchId: '', 
            hours: '', workers: '', 
            work_acc: '0', work_daysLost: '0', work_daysCharged: '0', 
            itinere_acc: '0', itinere_daysLost: '0', itinere_daysCharged: '0', 
            mission_acc: '0', mission_daysLost: '0', mission_daysCharged: '0', 
            recreation_acc: '0', recreation_daysLost: '0', recreation_daysCharged: '0' 
        };

        const FIELD_LABELS = {
            id: "ID Interno", month: "Mes", year: "Año", department: "Departamento", branchId: "ID Sucursal",
            hours: "Horas Hombre", workers: "Nro Trabajadores",
            work_acc: "Acc. Trabajo (Eventos)", work_daysLost: "Acc. Trabajo (Días Perdidos)", work_daysCharged: "Acc. Trabajo (Días Cargados)",
            itinere_acc: "In Itinere (Eventos)", itinere_daysLost: "In Itinere (Días Perdidos)", itinere_daysCharged: "In Itinere (Días Cargados)",
            mission_acc: "En Misión (Eventos)", mission_daysLost: "En Misión (Días Perdidos)", mission_daysCharged: "En Misión (Días Cargados)",
            recreation_acc: "Recreativos (Eventos)", recreation_daysLost: "Recreativos (Días Perdidos)", recreation_daysCharged: "Recreativos (Días Cargados)"
        };

        const LABELS_TO_FIELDS = Object.fromEntries(Object.entries(FIELD_LABELS).map(([key, label]) => [label, key]));
        const EVENT_TYPES = ['Todos', 'Trabajo', 'Itinere', 'Misión', 'Recreativo'];
        const YEARS = Array.from({length: 21}, (_, i) => 2020 + i); 

        // --- COMPONENTES ICONOS ---
        const Icon = ({ d, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d={d} />{props.children}</svg>);
        const Icons = {
            Activity: (p) => <Icon d="M22 12h-4l-3 9L9 3l-3 9H2" {...p}/>,
            Save: (p) => <Icon d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" {...p}><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
            Trash2: (p) => <Icon d="M3 6h18" {...p}><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>,
            Download: (p) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" {...p}><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>,
            Upload: (p) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" {...p}><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>,
            BarChart3: (p) => <Icon d="M18 20V10" {...p}><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></Icon>,
            TrendingUp: (p) => <Icon d="M23 6l-9.5 9.5-5-5L1 18" {...p}><polyline points="17 6 23 6 23 12"/></Icon>,
            Calendar: (p) => <Icon d="M3 4h18v18H3z" {...p}><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>,
            Briefcase: (p) => <Icon d="M20 7h-3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2H4" {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/></Icon>,
            Truck: (p) => <Icon d="M1 3h15v13H1z" {...p}><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></Icon>,
            Plane: (p) => <Icon d="M2 12h5l8-9 2 1-4 8h5l4-3 2 1-7 10h-2l2-8H2z" {...p}/>,
            PartyPopper: (p) => <Icon d="M5.8 11.3 2 22l10.7-3.79" {...p}><path d="M4 3h.01"/><path d="M22 8h.01"/><path d="M15 2h.01"/><path d="M22 20h.01"/></Icon>,
            Building2: (p) => <Icon d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" {...p}><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/></Icon>,
            Filter: (p) => <Icon d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" {...p}/>,
            PieChart: (p) => <Icon d="M21.21 15.89A10 10 0 1 1 8 2.83" {...p}><path d="M22 12A10 10 0 0 0 12 2v10z"/></Icon>,
            Globe: (p) => <Icon d="M2 12h20" {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10z"/></Icon>,
            User: (p) => <Icon d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" {...p}><circle cx="12" cy="7" r="4"/></Icon>,
            Settings: (p) => <Icon d="M12.22 2h-.44a2 2 0 0 1-2-1.08l-.12-.24a2 2 0 0 0-3.4 0l-.12.24a2 2 0 0 1-2 1.08H3.9c-.98 0-1.82.75-1.89 1.73l-.11 1.56a2 2 0 0 1-1.38 1.86l-.24.08a2 2 0 0 0 0 3.78l.24.08a2 2 0 0 1 1.38 1.86l.11 1.56c.07.98.91 1.73 1.89 1.73h.22a2 2 0 0 1 2 1.08l.12.24a2 2 0 0 0 3.4 0l.12-.24a2 2 0 0 1 2-1.08h.22c.98 0 1.82-.75 1.89-1.73l.11-1.56a2 2 0 0 1 1.38-1.86l.24-.08a2 2 0 0 0 0-3.78l-.24-.08a2 2 0 0 1-1.38-1.86l-.11-1.56c-.07-.98-.91-1.73-1.89-1.73z" {...p}><circle cx="12" cy="12" r="3"/></Icon>,
            Plus: (p) => <Icon d="M12 5v14" {...p}><line x1="5" y1="12" x2="19" y2="12"/></Icon>,
            X: (p) => <Icon d="M18 6L6 18" {...p}><line x1="6" y1="6" x2="18" y2="18"/></Icon>,
            Edit2: (p) => <Icon d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" {...p}/>,
            RefreshCw: (p) => <Icon d="M23 4v6h-6" {...p}><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></Icon>,
            Check: (p) => <Icon d="M20 6L9 17l-5-5" {...p}/>,
            AlertCircle: (p) => <Icon d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" {...p}><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>,
            Database: (p) => <Icon d="M12 22c4.97 0 9-1.79 9-4s-4.03-4-9-4-9 1.79-9 4 4.03 4 9 4z" {...p}><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>,
            FileText: (p) => <Icon d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" {...p}><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            Calculator: (p) => <Icon d="M16 2H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" {...p}><line x1="10" y1="12" x2="14" y2="12"/><line x1="10" y1="16" x2="14" y2="16"/></Icon>,
            BookOpen: (p) => <Icon d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" {...p}><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Icon>,
            Info: (p) => <Icon d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" {...p}><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Icon>,
            MapPin: (p) => <Icon d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" {...p}><circle cx="12" cy="10" r="3"/></Icon>,
            Map: (p) => <Icon d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z" {...p}><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></Icon>,
            Printer: (p) => <Icon d="M6 9V2h12v7" {...p}><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
            Camera: (p) => <Icon d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" {...p}><circle cx="12" cy="13" r="4"/></Icon>,
            Layout: (p) => <Icon d="M3 3h18v18H3z" {...p}><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></Icon>,
            RotateCcw: (p) => <Icon d="M1 4v6h6" {...p}><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></Icon>,
            Mail: (p) => <Icon d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" {...p}><polyline points="22,6 12,13 2,6" /></Icon>,
            Phone: (p) => <Icon d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" {...p} />,
            HelpCircle: (p) => <Icon d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" {...p}><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>
        };

        const safeCalc = (num, den, factor = 1) => {
            const n = parseFloat(num) || 0;
            const d = parseFloat(den) || 0;
            if (d === 0) return "0.00";
            return ((n * factor) / d).toFixed(2);
        };

        // --- UTILIDADES ---
        const triggerDownload = (canvas, filename) => {
            const link = document.createElement('a');
            link.download = `${filename}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        const downloadElementAsPng = async (elementId, filename) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            try {
                const canvas = await html2canvas(element, { 
                    scale: 2, backgroundColor: '#ffffff', useCORS: true, logging: false, ignoreElements: (el) => el.classList.contains('no-print') 
                });
                triggerDownload(canvas, filename);
            } catch (err) { console.error("Error PNG:", err); alert("Error al exportar imagen."); }
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [records, setRecords] = useState([]);
            const [departments, setDepartments] = useState(INITIAL_DEPARTMENTS);
            const [branches, setBranches] = useState(INITIAL_BRANCHES);
            const [kValue, setKValue] = useState(1000000);
            const [view, setView] = useState('dashboard');
            const [formData, setFormData] = useState({...INITIAL_FORM, department: 'Producción', branchId: 'b1'});
            const [editingId, setEditingId] = useState(null);
            
            const [filterDept, setFilterDept] = useState('Todos');
            const [filterBranch, setFilterBranch] = useState('Todos');
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [filterType, setFilterType] = useState('Trabajo');
            const [notification, setNotification] = useState(null);
            const [billboardMode, setBillboardMode] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [showResetModal, setShowResetModal] = useState(false); 
            const [showHelpModal, setShowHelpModal] = useState(false); 
            const [showDemoModal, setShowDemoModal] = useState(false); 

            const [newDeptName, setNewDeptName] = useState('');
            const [newBranchName, setNewBranchName] = useState('');
            const [newBranchState, setNewBranchState] = useState(VENEZUELA_STATES[9]);

            const fileInputRef = useRef(null);

            useEffect(() => {
                if (departments.length > 0 && (!formData.department || !departments.includes(formData.department))) {
                    setFormData(prev => ({ ...prev, department: departments[0] }));
                }
                if (branches.length > 0 && (!formData.branchId || !branches.find(b => b.id === formData.branchId))) {
                    setFormData(prev => ({ ...prev, branchId: branches[0].id }));
                }
            }, [departments, branches]);

            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            // CÁLCULOS
            const filteredRecords = useMemo(() => {
                return records.filter(r => {
                    const matchDept = filterDept === 'Todos' || r.department === filterDept;
                    const matchBranch = filterBranch === 'Todos' || r.branchId === filterBranch;
                    const matchYear = Number(r.year) === Number(filterYear);
                    return matchDept && matchBranch && matchYear;
                });
            }, [records, filterDept, filterBranch, filterYear]);

            const monthlyStats = useMemo(() => {
                const map = {};
                filteredRecords.forEach(r => {
                    const k = r.month;
                    if(!map[k]) map[k] = { 
                        month: k, year: r.year, hours:0, workers:0, c:0, 
                        dL:0, dC:0, aL:0, accT:0, 
                        iti:0, itiD:0, mis:0, misD:0, rec:0, recD:0
                    };
                    map[k].hours += Number(r.hours || 0); 
                    map[k].workers += Number(r.workers || 0); 
                    map[k].c++;
                    
                    // Función auxiliar para lógica unificada
                    const processEvent = (events, daysL, daysC) => {
                        const evs = Number(events || 0);
                        const days = Number(daysL || 0) + Number(daysC || 0);
                        if (days > 0) map[k].aL += evs; 
                        map[k].accT += evs; 
                        map[k].dL += Number(daysL || 0);
                        map[k].dC += Number(daysC || 0);
                    };

                    // Procesar Trabajo
                    processEvent(r.work_acc, r.work_daysLost, r.work_daysCharged);
                    
                    // Procesar Itinere
                    map[k].iti += Number(r.itinere_acc || 0);
                    map[k].itiD += (Number(r.itinere_daysLost || 0) + Number(r.itinere_daysCharged || 0));
                    
                    // Procesar Misión
                    map[k].mis += Number(r.mission_acc || 0);
                    map[k].misD += (Number(r.mission_daysLost || 0) + Number(r.mission_daysCharged || 0));
                    
                    // Procesar Recreativo
                    map[k].rec += Number(r.recreation_acc || 0);
                    map[k].recD += (Number(r.recreation_daysLost || 0) + Number(r.recreation_daysCharged || 0));
                });

                return MONTHS.map(m => {
                    const d = map[m] || { month: m, hours:0, workers:0, c:1, dL:0, dC:0, aL:0, accT:0, iti:0, itiD:0, mis:0, misD:0, rec:0, recD:0 };
                    const wAvg = Math.round(d.workers / (d.c||1));
                    
                    let filteredCount = 0;
                    let filteredDays = 0;
                    let filteredLostTimeEvents = 0; 

                    const monthRecs = filteredRecords.filter(rec => rec.month === m);
                    
                    monthRecs.forEach(r => {
                        let e = 0, dL = 0, dC = 0;
                        
                        if (filterType === 'Todos') {
                            e = Number(r.work_acc || 0) + Number(r.itinere_acc || 0) + Number(r.mission_acc || 0) + Number(r.recreation_acc || 0);
                            dL = Number(r.work_daysLost || 0) + Number(r.itinere_daysLost || 0) + Number(r.mission_daysLost || 0) + Number(r.recreation_daysLost || 0);
                            dC = Number(r.work_daysCharged || 0) + Number(r.itinere_daysCharged || 0) + Number(r.mission_daysCharged || 0) + Number(r.recreation_daysCharged || 0);
                        } else if (filterType === 'Trabajo') {
                            e = Number(r.work_acc || 0); dL = Number(r.work_daysLost || 0); dC = Number(r.work_daysCharged || 0);
                        } else if (filterType === 'Itinere') {
                            e = Number(r.itinere_acc || 0); dL = Number(r.itinere_daysLost || 0); dC = Number(r.itinere_daysCharged || 0);
                        } else if (filterType === 'Misión') {
                            e = Number(r.mission_acc || 0); dL = Number(r.mission_daysLost || 0); dC = Number(r.mission_daysCharged || 0);
                        } else if (filterType === 'Recreativo') {
                            e = Number(r.recreation_acc || 0); dL = Number(r.recreation_daysLost || 0); dC = Number(r.recreation_daysCharged || 0);
                        }

                        filteredCount += e;
                        filteredDays += (dL + dC);
                        if ((dL + dC) > 0) filteredLostTimeEvents += e;
                    });

                    return {
                        month: m, hours: d.hours, workersAvg: wAvg, 
                        totalWorkAcc: d.accT, 
                        
                        ifn: safeCalc(filteredLostTimeEvents, d.hours, kValue),
                        ifb: safeCalc(filteredCount, d.hours, kValue),
                        is: safeCalc(filteredDays, d.hours, kValue),
                        
                        dynamicCount: filteredCount,
                        dynamicDays: filteredDays,
                        
                        itinere_acc: d.iti, mission_acc: d.mis, recreation_acc: d.rec
                    };
                });
            }, [filteredRecords, kValue, filterType]);

            const globalStats = useMemo(() => {
                const totalHours = monthlyStats.reduce((s, d) => s + d.hours, 0);
                
                let totalEvents = 0;
                let totalLostTimeEvents = 0;
                let totalDays = 0;

                filteredRecords.forEach(r => {
                    let e = 0, dL = 0, dC = 0;
                    
                    if (filterType === 'Todos') {
                        e = Number(r.work_acc || 0) + Number(r.itinere_acc || 0) + Number(r.mission_acc || 0) + Number(r.recreation_acc || 0);
                        dL = Number(r.work_daysLost || 0) + Number(r.itinere_daysLost || 0) + Number(r.mission_daysLost || 0) + Number(r.recreation_daysLost || 0);
                        dC = Number(r.work_daysCharged || 0) + Number(r.itinere_daysCharged || 0) + Number(r.mission_daysCharged || 0) + Number(r.recreation_daysCharged || 0);
                    } else if (filterType === 'Trabajo') {
                        e = Number(r.work_acc || 0); dL = Number(r.work_daysLost || 0); dC = Number(r.work_daysCharged || 0);
                    } else if (filterType === 'Itinere') {
                        e = Number(r.itinere_acc || 0); dL = Number(r.itinere_daysLost || 0); dC = Number(r.itinere_daysCharged || 0);
                    } else if (filterType === 'Misión') {
                        e = Number(r.mission_acc || 0); dL = Number(r.mission_daysLost || 0); dC = Number(r.mission_daysCharged || 0);
                    } else if (filterType === 'Recreativo') {
                        e = Number(r.recreation_acc || 0); dL = Number(r.recreation_daysLost || 0); dC = Number(r.recreation_daysCharged || 0);
                    }

                    totalEvents += e;
                    totalDays += (dL + dC);
                    if ((dL + dC) > 0) totalLostTimeEvents += e;
                });
                
                const sumWork = filteredRecords.reduce((s,r) => s + Number(r.work_acc || 0), 0);
                const sumIti = filteredRecords.reduce((s,r) => s + Number(r.itinere_acc || 0), 0);
                const sumMis = filteredRecords.reduce((s,r) => s + Number(r.mission_acc || 0), 0);
                const sumRec = filteredRecords.reduce((s,r) => s + Number(r.recreation_acc || 0), 0);

                return {
                    hours: totalHours,
                    ifn: safeCalc(totalLostTimeEvents, totalHours, kValue),
                    ifb: safeCalc(totalEvents, totalHours, kValue),
                    is: safeCalc(totalDays, totalHours, kValue),
                    dynamicCountTotal: totalEvents,
                    totalWorkAcc: sumWork, itinere: sumIti, mission: sumMis, rec: sumRec
                };
            }, [monthlyStats, filteredRecords, kValue, filterType]);

            // --- EXPORTAR A EXCEL (Traducción + Plantilla) ---
            const exportData = () => {
                // Validación de librería
                if (typeof XLSX === 'undefined') {
                    alert("Error: La librería de Excel no se ha cargado correctamente. Verifique su conexión a internet.");
                    return;
                }

                try {
                    let ws;
                    let fileName;
                    const dataToExport = records.map(record => {
                        const translatedRecord = {};
                        Object.keys(record).forEach(key => {
                            const label = FIELD_LABELS[key] || key; 
                            translatedRecord[label] = record[key];
                        });
                        return translatedRecord;
                    });

                    if (dataToExport.length === 0) {
                        const headers = Object.values(FIELD_LABELS);
                        ws = XLSX.utils.aoa_to_sheet([headers]); 
                        fileName = `SST_Plantilla_Carga_${new Date().toISOString().slice(0,10)}.xlsx`;
                        setNotification("Plantilla vacía descargada.");
                    } else {
                        ws = XLSX.utils.json_to_sheet(dataToExport);
                        fileName = `SST_Backup_${new Date().toISOString().slice(0,10)}.xlsx`;
                        setNotification("Excel exportado correctamente.");
                    }

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Registros");
                    XLSX.writeFile(wb, fileName);
                } catch (error) {
                    console.error("Error exportando Excel:", error);
                    alert("Hubo un error al generar el archivo Excel.");
                }
            };

            // --- IMPORTAR DESDE EXCEL (Traducción Inversa) ---
            const importData = (e) => {
                if (typeof XLSX === 'undefined') {
                    alert("Error: La librería de Excel no se ha cargado correctamente.");
                    return;
                }
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = new Uint8Array(ev.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        let rawRecords = XLSX.utils.sheet_to_json(worksheet);

                        if (rawRecords.length > 0) {
                            const importedRecords = rawRecords.map((r, idx) => {
                                const internalRecord = {};
                                Object.keys(r).forEach(label => {
                                    const key = LABELS_TO_FIELDS[label] || label; 
                                    internalRecord[key] = r[label];
                                });
                                return { ...internalRecord, id: internalRecord.id || (Date.now() + idx).toString() };
                            });

                            setRecords(importedRecords);
                            const importedDepts = [...new Set(importedRecords.map(r => r.department))].filter(Boolean);
                            if (importedDepts.length > 0) setDepartments(prev => [...new Set([...prev, ...importedDepts])]);
                            setNotification("Datos Excel importados correctamente.");
                            if(importedRecords[0].year) setFilterYear(Number(importedRecords[0].year));
                            e.target.value = '';
                        } else {
                            alert("El archivo Excel parece estar vacío.");
                        }
                    } catch (err) { console.error(err); alert("Error al leer el archivo Excel. Verifique el formato."); }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleDownloadPDF = async () => {
                setIsExporting(true);
                if(view !== 'dashboard') { setView('dashboard'); await new Promise(r => setTimeout(r, 100)); }
                const element = document.getElementById('app-container');
                if (!element) { setIsExporting(false); return; }
                const originalScrollPos = window.scrollY;
                window.scrollTo(0, 0);

                try {
                    const cloneContainer = document.createElement('div');
                    cloneContainer.style.cssText = 'position:absolute;top:0;left:0;width:100%;z-index:10000;background:#ffffff;pointer-events:none;';
                    document.body.appendChild(cloneContainer);

                    const clonedNode = element.cloneNode(true);
                    clonedNode.style.cssText = 'height:auto;overflow:visible;max-height:none;';
                    
                    clonedNode.querySelectorAll('.no-print').forEach(btn => btn.style.display = 'none');
                    element.querySelectorAll('svg').forEach((orig, idx) => {
                        const clone = clonedNode.querySelectorAll('svg')[idx];
                        if (clone) {
                            const rect = orig.getBoundingClientRect();
                            clone.setAttribute('width', rect.width);
                            clone.setAttribute('height', rect.height);
                            clone.style.width = `${rect.width}px`;
                            clone.style.height = `${rect.height}px`;
                            clone.style.display = 'block';
                        }
                    });

                    cloneContainer.appendChild(clonedNode);
                    await new Promise(r => setTimeout(r, 100));
                    const canvas = await html2canvas(clonedNode, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false });
                    document.body.removeChild(cloneContainer);
                    window.scrollTo(0, originalScrollPos);

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = 210; const pdfHeight = 297; const margin = 10;
                    const contentWidth = pdfWidth - (2 * margin);
                    const contentHeight = (canvas.height * contentWidth) / canvas.width;
                    
                    if (contentHeight > (pdfHeight - 20)) {
                        const ratio = (pdfHeight - 20) / contentHeight;
                        const scaledWidth = contentWidth * ratio;
                        const xOffset = margin + (contentWidth - scaledWidth) / 2;
                        pdf.addImage(imgData, 'PNG', xOffset, margin, scaledWidth, (pdfHeight - 20));
                    } else {
                        pdf.addImage(imgData, 'PNG', margin, margin, contentWidth, contentHeight);
                    }

                    pdf.addPage();
                    pdf.setFontSize(14);
                    pdf.text(`Detalle de Datos - Año ${filterYear}`, margin, 20);
                    
                    const columns = ["Mes", "H.H.E.", "IFN", "IFB", "IS", "Acc.", "Itinere", "Misión", "Rec."];
                    const rows = monthlyStats.map(r => [ r.month, Number(r.hours).toLocaleString(), r.ifn, r.ifb, r.is, r.totalWorkAcc, r.itinere_acc, r.mission_acc, r.recreation_acc ]);
                    rows.push(["TOTAL", globalStats.hours.toLocaleString(), globalStats.ifn, globalStats.ifb, globalStats.is, globalStats.totalWorkAcc, globalStats.itinere, globalStats.mission, globalStats.rec]);

                    pdf.autoTable({
                        head: [columns], body: rows, startY: 30, theme: 'grid',
                        headStyles: { fillColor: [0, 176, 80], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [51, 65, 85], textColor: 255, fontStyle: 'bold' },
                        styles: { fontSize: 9, cellPadding: 3 },
                        didParseRow: function(data) { if (data.row.index === rows.length - 1) { data.row.styles.fontStyle = 'bold'; data.row.styles.fillColor = [220, 220, 220]; } }
                    });

                    const totalPages = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(8);
                        pdf.setTextColor(150);
                        const str = `Página ${i} de ${totalPages} - Elaborado por: David Linares Brea - www.movidasst.com`;
                        pdf.text(str, margin, pdfHeight - 10);
                    }

                    pdf.save(`SST_Reporte_Completo_${filterYear}.pdf`);
                    setNotification("Reporte Completo Generado");
                } catch (err) { console.error("Error PDF:", err); alert("Error al generar PDF."); if(document.querySelector('div[style*="z-index: 10000"]')) document.body.removeChild(document.querySelector('div[style*="z-index: 10000"]')); } finally { setIsExporting(false); }
            };

            const confirmReset = () => {
                setRecords([]); setDepartments(INITIAL_DEPARTMENTS); setBranches(INITIAL_BRANCHES); setKValue(1000000); 
                setFilterDept('Todos'); setFilterBranch('Todos'); setFilterType('Todos'); setFilterYear(new Date().getFullYear());
                setFormData({...INITIAL_FORM, department: INITIAL_DEPARTMENTS[0], branchId: INITIAL_BRANCHES[0].id});
                setShowResetModal(false); setNotification("Sistema reiniciado correctamente."); setView('dashboard');
            };

            const handleReset = () => setShowResetModal(true);
            const handlePrint = () => { setTimeout(() => window.print(), 500); };
            
            const confirmLoadDemo = () => {
                setEditingId(null); setRecords([]);
                setDepartments(['Producción', 'Ventas', 'Admin', 'Logística']);
                setBranches([{id: 'b1', name: 'Caracas'}, {id: 'b2', name: 'Valencia'}]);
                const recs = []; const rand = (a, b) => Math.floor(Math.random()*(b-a+1))+a;
                const year = new Date().getFullYear();
                MONTHS.forEach((m, i) => {
                    recs.push({id: `demo-${i}-1`, month: m, year, department: 'Producción', branchId: 'b1', hours: 5000, workers: 30, work_acc: rand(0,2), work_daysLost: rand(0,5), work_daysCharged: 0, itinere_acc: 0, itinere_daysLost: 0, itinere_daysCharged: 0, mission_acc: 0, mission_daysLost: 0, mission_daysCharged: 0, recreation_acc: 0, recreation_daysLost: 0, recreation_daysCharged: 0});
                    recs.push({id: `demo-${i}-2`, month: m, year, department: 'Ventas', branchId: 'b2', hours: 3000, workers: 15, work_acc: 0, work_daysLost: 0, work_daysCharged: 0, itinere_acc: rand(0,1), itinere_daysLost: rand(0,3), itinere_daysCharged: 0, mission_acc: rand(0,1), mission_daysLost: 0, mission_daysCharged: 0, recreation_acc: 0, recreation_daysLost: 0, recreation_daysCharged: 0});
                });
                setRecords(recs); setFilterYear(year); setFilterDept('Todos'); setFilterBranch('Todos'); setFilterType('Todos'); setView('dashboard'); setShowDemoModal(false); setNotification("Datos demo cargados exitosamente.");
            };
            const handleLoadDemo = () => setShowDemoModal(true);

            const addBranch = (e) => { e.preventDefault(); if(newBranchName){ setBranches([...branches, {id: Date.now().toString(), name: newBranchName, state: newBranchState}]); setNewBranchName(''); }};
            const removeBranch = (id) => { if(confirm("¿Borrar sucursal?")) setBranches(branches.filter(b=>b.id!==id)); };
            const addDept = (e) => { e.preventDefault(); if(newDeptName){ setDepartments([...departments, newDeptName]); setNewDeptName(''); }};
            const removeDept = (d) => { if(confirm("¿Borrar depto?")) setDepartments(departments.filter(x=>x!==d)); };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                const newRec = { ...formData, id: Date.now(), year: Number(formData.year), hours: Number(formData.hours), workers: Number(formData.workers), work_acc: Number(formData.work_acc), work_daysLost: Number(formData.work_daysLost), work_daysCharged: Number(formData.work_daysCharged), itinere_acc: Number(formData.itinere_acc), itinere_daysLost: Number(formData.itinere_daysLost), itinere_daysCharged: Number(formData.itinere_daysCharged), mission_acc: Number(formData.mission_acc), mission_daysLost: Number(formData.mission_daysLost), mission_daysCharged: Number(formData.mission_daysCharged), recreation_acc: Number(formData.recreation_acc), recreation_daysLost: Number(formData.recreation_daysLost), recreation_daysCharged: Number(formData.recreation_daysCharged) };
                if(editingId) { setRecords(records.map(r => r.id === editingId ? {...newRec, id: editingId} : r)); setNotification("Actualizado."); setEditingId(null); } else { setRecords([...records, newRec]); setNotification("Guardado."); }
                
                // AUTO-VISUALIZACIÓN:
                setFilterYear(Number(formData.year));
                setFilterType('Todos'); 

                const idx = MONTHS.indexOf(formData.month); const nextMonth = MONTHS[(idx + 1) % 12];
                setFormData({...formData, month: nextMonth, hours: '', workers: '', work_acc: '0', work_daysLost: '0', work_daysCharged: '0', itinere_acc: '0', itinere_daysLost: '0', itinere_daysCharged: '0', mission_acc: '0', mission_daysLost: '0', mission_daysCharged: '0', recreation_acc: '0', recreation_daysLost: '0', recreation_daysCharged: '0'});
            };
            const handleEdit = (r) => { const strRec = Object.fromEntries(Object.entries(r).map(([k, v]) => [k, String(v)])); setFormData(strRec); setEditingId(r.id); setView('input'); window.scrollTo({top: 0, behavior: 'smooth'}); };
            const cancelEdit = () => { setEditingId(null); setFormData({...INITIAL_FORM, department: departments[0], branchId: branches[0].id}); setView('input'); };
            const handleDelete = (id) => { if(confirm("¿Borrar?")) setRecords(records.filter(r=>r.id!==id)); };
            const handleInputChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            
            let content;
            switch(view) {
                case 'dashboard':
                    let typeTitle = filterType === 'Todos' ? 'GLOBAL' : filterType.toUpperCase();
                    content = (
                        <div className="space-y-8">
                            <div className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200 no-print gap-4">
                                <h2 className="font-bold text-lg flex gap-2"><Icons.BarChart3 className="h-6 w-6 text-emerald-600"/> Dashboard {filterYear}</h2>
                                <div className="flex flex-wrap gap-4 items-end">
                                    <div className="flex flex-col"><label className="text-xs font-bold text-slate-500 mb-1">Sucursal</label><select value={filterBranch} onChange={e=>setFilterBranch(e.target.value)} className="p-1 border rounded text-sm w-40"><option value="Todos">Todas Sucursales</option>{branches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-slate-500 mb-1">Departamento</label><select value={filterDept} onChange={e=>setFilterDept(e.target.value)} className="p-1 border rounded text-sm w-40"><option value="Todos">Todos Deptos</option>{departments.map(d=><option key={d} value={d}>{d}</option>)}</select></div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-slate-500 mb-1">Evento</label><select value={filterType} onChange={e=>setFilterType(e.target.value)} className="p-1 border rounded text-sm font-bold text-emerald-700 bg-emerald-50 w-32">{EVENT_TYPES.map(t=><option key={t} value={t}>{t}</option>)}</select></div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-slate-500 mb-1">Año</label><select value={filterYear} onChange={e=>setFilterYear(Number(e.target.value))} className="p-1 border rounded text-sm w-24">{YEARS.map(y => <option key={y} value={y}>{y}</option>)}</select></div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-4 gap-4">
                                <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100"><span className="text-xs font-bold text-emerald-600 uppercase">IFN ({typeTitle})</span><div className="text-3xl font-bold text-emerald-700 mt-1">{globalStats.ifn}</div></div>
                                <div className="bg-sky-50 p-4 rounded-xl border border-sky-100"><span className="text-xs font-bold text-sky-600 uppercase">IFB ({typeTitle})</span><div className="text-3xl font-bold text-sky-700 mt-1">{globalStats.ifb}</div></div>
                                <div className="bg-red-50 p-4 rounded-xl border border-red-100"><span className="text-xs font-bold text-red-600 uppercase">IS ({typeTitle})</span><div className="text-3xl font-bold text-red-700 mt-1">{globalStats.is}</div></div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200"><span className="text-xs font-bold text-slate-400 uppercase">Total Eventos ({typeTitle})</span><div className="text-3xl font-bold text-slate-700 mt-1">{globalStats.dynamicCountTotal}</div></div>
                            </div>

                            <div className="grid lg:grid-cols-2 gap-6">
                                <div id="chart-ifn-container" className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm h-72 relative group">
                                    <div className="flex justify-between mb-2"><h3 className="text-xs font-bold text-slate-500">TENDENCIA {typeTitle} (IFN vs IFB)</h3><button onClick={()=>downloadElementAsPng('chart-ifn-container', 'Grafico_Tendencia')} className="text-slate-400 hover:text-blue-500 no-print" title="Descargar PNG"><Icons.Camera className="h-4 w-4"/></button></div>
                                    <div className="h-full pb-6"><SimpleLineChart data={monthlyStats} dataKey1="ifn" dataKey2="ifb" color1={BRAND_COLOR} color2="#0ea5e9"/></div>
                                    <div className="flex justify-center gap-4 mt-2"><div className="flex items-center gap-1 text-xs"><span className="w-3 h-3 rounded-full" style={{backgroundColor: BRAND_COLOR}}></span> IFN</div><div className="flex items-center gap-1 text-xs"><span className="w-3 h-3 rounded-full bg-[#0ea5e9]"></span> IFB</div></div>
                                </div>
                                <div id="chart-is-container" className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm h-72 relative group">
                                    <div className="flex justify-between mb-2"><h3 className="text-xs font-bold text-slate-500">SEVERIDAD {typeTitle} (IS)</h3><button onClick={()=>downloadElementAsPng('chart-is-container', 'Grafico_Severidad')} className="text-slate-400 hover:text-blue-500 no-print" title="Descargar PNG"><Icons.Camera className="h-4 w-4"/></button></div>
                                    <div className="h-full pb-6"><SimpleBarChart data={monthlyStats} dataKey="is" color="#ef4444"/></div>
                                </div>
                            </div>
                            <div id="summary-table-container" className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative group">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold text-sm text-slate-700">Resumen Mensual Detallado</h3><button onClick={()=>downloadElementAsPng('summary-table-container', 'Tabla_Resumen')} className="text-slate-400 hover:text-blue-500 bg-white p-1 rounded border no-print" title="Descargar PNG"><Icons.Camera className="h-4 w-4"/></button></div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs text-left">
                                        <thead><tr className="bg-white border-b"><th className="p-3">Mes</th><th className="p-3 text-right">H.H.E.</th><th className="p-3 text-center text-emerald-700">IFN</th><th className="p-3 text-center text-sky-700">IFB</th><th className="p-3 text-center text-red-700">IS</th><th className="p-3 text-center bg-slate-50 font-bold">Acc. Trab.</th><th className="p-3 text-center">Itinere</th><th className="p-3 text-center">Misión</th><th className="p-3 text-center">Rec.</th></tr></thead>
                                        <tbody>{monthlyStats.map((r,i) => <tr key={i} className="border-b hover:bg-slate-50"><td className="p-3 font-medium">{r.month}</td><td className="p-3 text-right text-slate-500">{Number(r.hours).toLocaleString()}</td><td className="p-3 text-center font-bold text-emerald-600">{r.ifn}</td><td className="p-3 text-center font-bold text-sky-600">{r.ifb}</td><td className="p-3 text-center font-bold text-red-600">{r.is}</td><td className="p-3 text-center bg-slate-50 font-bold text-slate-700">{r.totalWorkAcc}</td><td className="p-3 text-center text-slate-400">{r.itinere_acc}</td><td className="p-3 text-center text-slate-400">{r.mission_acc}</td><td className="p-3 text-center text-slate-400">{r.recreation_acc}</td></tr>)}</tbody>
                                        <tfoot className="bg-slate-800 text-white font-bold"><tr><td className="p-3">TOTAL</td><td className="p-3 text-right">{globalStats.hours.toLocaleString()}</td><td className="p-3 text-center text-emerald-300">{globalStats.ifn}</td><td className="p-3 text-center text-sky-300">{globalStats.ifb}</td><td className="p-3 text-center text-red-300">{globalStats.is}</td><td className="p-3 text-center bg-slate-700">{globalStats.totalWorkAcc}</td><td className="p-3 text-center bg-slate-700">{globalStats.itinere}</td><td className="p-3 text-center bg-slate-700">{globalStats.mission}</td><td className="p-3 text-center bg-slate-700">{globalStats.rec}</td></tr></tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    );
                    break;
                case 'input':
                    content = (
                        <div className="animate-in fade-in no-print">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                                <div className="p-4 flex items-center justify-between border-b border-slate-100 bg-slate-50">
                                    <h2 className="font-bold flex items-center gap-2 text-lg" style={{ color: NEUTRAL_COLOR }}>{editingId ? <><Icons.Edit2 className="h-5 w-5 text-amber-500" /> Editando</> : <><Icons.FileText className="h-5 w-5" style={{ color: BRAND_COLOR }} /> Nuevo Registro</>}</h2>
                                    {editingId && <button onClick={cancelEdit} className="text-xs bg-slate-200 px-3 py-1 rounded">Cancelar</button>}
                                </div>
                                <form onSubmit={handleSubmit} className="p-6 space-y-8">
                                    <div className="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6 text-xs text-blue-800 space-y-1">
                                        <h3 className="font-bold mb-2 flex items-center gap-2"><Icons.Info className="h-4 w-4"/> Guía de Clasificación de Accidentes</h3>
                                        <p><strong>Accidente de Trabajo:</strong> Ocurridos dentro de la empresa.</p>
                                        <p><strong>In Itinere:</strong> Ocurridos en el trayecto habitual entre la casa y el trabajo (o viceversa).</p>
                                        <p><strong>En Misión:</strong> Ocurridos fuera de la empresa cumpliendo una orden o actividad asignada.</p>
                                        <p><strong>Recreativos:</strong> Ocurridos durante actividades deportivas o culturales patrocinadas por el empleador.</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div><label className="label-text">Sucursal</label><select name="branchId" value={formData.branchId} onChange={handleInputChange} className="input-field">{branches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></div>
                                        <div><label className="label-text">Depto</label><select name="department" value={formData.department} onChange={handleInputChange} className="input-field">{departments.map(d=><option key={d} value={d}>{d}</option>)}</select></div>
                                        <div className="grid grid-cols-2 gap-2"><div><label className="label-text">Mes</label><select name="month" value={formData.month} onChange={handleInputChange} className="input-field">{MONTHS.map(m=><option key={m} value={m}>{m}</option>)}</select></div><div><label className="label-text">Año</label><input type="number" name="year" value={formData.year} onChange={handleInputChange} className="input-field"/></div></div>
                                        <div className="grid grid-cols-2 gap-2"><div><label className="label-text">H.H.E.</label><input type="number" name="hours" value={formData.hours} onChange={handleInputChange} className="input-field"/></div><div><label className="label-text">Trab.</label><input type="number" name="workers" value={formData.workers} onChange={handleInputChange} className="input-field"/></div></div>
                                    </div>
                                    <hr className="border-slate-100"/>
                                    
                                    <div className="grid grid-cols-1 gap-4">
                                        <div className="bg-white p-4 rounded border border-emerald-200 bg-emerald-50">
                                            <div className="flex items-center gap-2 mb-2 text-xs font-bold uppercase text-emerald-700">
                                                <Icons.Briefcase className="h-4 w-4"/> Accidente de Trabajo
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div><label className="text-[10px]">Eventos</label><input type="number" name="work_acc" value={formData.work_acc} onChange={handleInputChange} className="input-field h-8 border-emerald-300" /></div>
                                                <div><label className="text-[10px]">D. Perd.</label><input type="number" name="work_daysLost" value={formData.work_daysLost} onChange={handleInputChange} className="input-field h-8 border-emerald-300" /></div>
                                                <div><label className="text-[10px]">D. Carg.</label><input type="number" name="work_daysCharged" value={formData.work_daysCharged} onChange={handleInputChange} className="input-field h-8 border-emerald-300" /></div>
                                            </div>
                                            <p className="text-[10px] text-emerald-600 mt-2 italic">
                                                * Nota: Si registra días (Perdidos o Cargados), el evento se contará automáticamente como "Con Baja" para el cálculo del IFN. Si los días son 0, se contará como "Sin Baja". ESTA NOTA TAMBIÉN APLICA PARA ITINERE, EN MISIÓN Y RECREATIVOS.
                                            </p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-4">
                                        <CategoryCard icon={Icons.Truck} title="In Itinere" accName="itinere_acc" daysLostName="itinere_daysLost" daysChargedName="itinere_daysCharged" formData={formData} onChange={handleInputChange}/>
                                        <CategoryCard icon={Icons.Plane} title="En Misión" accName="mission_acc" daysLostName="mission_daysLost" daysChargedName="mission_daysCharged" formData={formData} onChange={handleInputChange}/>
                                        <CategoryCard icon={Icons.PartyPopper} title="Recreativos" accName="recreation_acc" daysLostName="recreation_daysLost" daysChargedName="recreation_daysCharged" formData={formData} onChange={handleInputChange}/>
                                    </div>
                                    <div className="flex justify-end gap-2"><button type="submit" className="btn-primary-action header-btn px-4 py-2 rounded text-sm">Guardar</button></div>
                                </form>
                            </div>
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b border-slate-100 bg-slate-50 font-bold text-sm">Registros Existentes</div>
                                <div className="overflow-x-auto max-h-60">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-slate-50">
                                            <tr>
                                                <th className="p-2">Fecha</th>
                                                <th className="p-2">Sucursal</th>
                                                <th className="p-2">Depto</th>
                                                <th className="p-2 text-center" title="Accidentes de Trabajo">Trab.</th>
                                                <th className="p-2 text-center" title="In Itinere">Itin.</th>
                                                <th className="p-2 text-center" title="En Misión">Mis.</th>
                                                <th className="p-2 text-center" title="Recreativos">Rec.</th>
                                                <th className="p-2 text-right">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {records.slice().reverse().map(r => {
                                                const branchName = branches.find(b => b.id === r.branchId)?.name || 'N/A';
                                                return (
                                                    <tr key={r.id} className="border-t hover:bg-slate-50 transition-colors">
                                                        <td className="p-2 font-medium">{r.month} {r.year}</td>
                                                        <td className="p-2 text-slate-600">{branchName}</td>
                                                        <td className="p-2 text-slate-600">{r.department}</td>
                                                        <td className="p-2 text-center font-bold text-emerald-600">{Number(r.work_acc)}</td>
                                                        <td className="p-2 text-center text-slate-500">{Number(r.itinere_acc)}</td>
                                                        <td className="p-2 text-center text-slate-500">{Number(r.mission_acc)}</td>
                                                        <td className="p-2 text-center text-slate-500">{Number(r.recreation_acc)}</td>
                                                        <td className="p-2 flex gap-2 justify-end">
                                                            <button onClick={()=>handleEdit(r)} className="text-blue-500 hover:text-blue-700 p-1"><Icons.Edit2 className="h-4 w-4"/></button>
                                                            <button onClick={()=>handleDelete(r.id)} className="text-red-500 hover:text-red-700 p-1"><Icons.Trash2 className="h-4 w-4"/></button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    );
                    break;
                case 'settings':
                    content = (
                        <SettingsOrInputView view='settings' departments={departments} branches={branches} addBranch={addBranch} newBranchName={newBranchName} setNewBranchName={setNewBranchName} newBranchState={newBranchState} setNewBranchState={setNewBranchState} removeBranch={removeBranch} addDept={addDept} newDeptName={newDeptName} setNewDeptName={setNewDeptName} removeDept={removeDept} kValue={kValue} setKValue={setKValue} />
                    );
                    break;
            }

            return (
                <div id="app-container" className={`min-h-screen ${billboardMode?'bg-white':'bg-slate-50'}`}>
                    {isExporting && <div className="export-loader"><div className="spinner"></div><p className="mt-2 text-slate-600 font-bold">Generando Reporte PDF Completo...</p></div>}
                    {notification && <div className="fixed top-4 right-4 z-[100] bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl animate-bounce flex items-center gap-2"><Icons.Check className="h-5 w-5 text-emerald-400"/>{notification}</div>}

                    {/* MODAL DE REINICIO */}
                    {showResetModal && (
                        <div className="modal-overlay">
                            <div className="modal-content animate-in zoom-in-95">
                                <div className="mb-4 text-red-500 flex justify-center"><Icons.AlertCircle className="h-12 w-12"/></div>
                                <h3 className="text-lg font-bold text-slate-800 mb-2">¿Estás seguro de reiniciar todo?</h3>
                                <p className="text-sm text-slate-500 mb-6">Esta acción borrará todos los datos cargados, filtros y configuraciones. No se puede deshacer.</p>
                                <div className="flex gap-3 justify-center">
                                    <button onClick={() => setShowResetModal(false)} className="px-4 py-2 border rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                                    <button onClick={confirmReset} className="px-4 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-600">Sí, Reiniciar Todo</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MODAL DE CONFIRMACIÓN DE DEMO */}
                    {showDemoModal && (
                        <div className="modal-overlay">
                            <div className="modal-content animate-in zoom-in-95">
                                <div className="mb-4 text-orange-500 flex justify-center"><Icons.Database className="h-12 w-12"/></div>
                                <h3 className="text-lg font-bold text-slate-800 mb-2">¿Cargar Datos de Prueba?</h3>
                                <p className="text-sm text-slate-500 mb-6">Se reemplazarán todos los registros actuales por un conjunto de datos de ejemplo (Año {new Date().getFullYear()}).</p>
                                <div className="flex gap-3 justify-center">
                                    <button onClick={() => setShowDemoModal(false)} className="px-4 py-2 border rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                                    <button onClick={confirmLoadDemo} className="px-4 py-2 bg-orange-500 text-white rounded font-bold hover:bg-orange-600">Sí, Cargar Demo</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MODAL DE AYUDA */}
                    {showHelpModal && (
                        <div className="modal-overlay" onClick={() => setShowHelpModal(false)}>
                            <div className="modal-content animate-in zoom-in-95" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.HelpCircle className="h-6 w-6 text-indigo-500"/> Guía Rápida de Uso</h3>
                                    <button onClick={() => setShowHelpModal(false)} className="text-slate-400 hover:text-slate-600"><Icons.X className="h-5 w-5"/></button>
                                </div>
                                
                                <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                    <div className="help-step">
                                        <div className="help-number">1</div>
                                        <div>
                                            <h4 className="font-bold text-sm text-slate-700">Configuración Inicial</h4>
                                            <p className="text-xs text-slate-500">Vaya a <span className="font-bold text-indigo-600">Config</span> para agregar sus Sucursales y Departamentos. Defina la constante K (1.000.000 o 200.000).</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-number">2</div>
                                        <div>
                                            <h4 className="font-bold text-sm text-slate-700">Registro de Datos</h4>
                                            <p className="text-xs text-slate-500">En <span className="font-bold text-emerald-600">Cargar Mes</span> ingrese las Horas Hombre, Trabajadores y eventos ocurridos. Puede editar registros abajo en la tabla.</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-number">3</div>
                                        <div>
                                            <h4 className="font-bold text-sm text-slate-700">Análisis y Filtros</h4>
                                            <p className="text-xs text-slate-500">En <span className="font-bold text-emerald-600">Ver Datos</span>, use los filtros superiores para ver estadísticas específicas por Sucursal, Depto. o Tipo de Evento.</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-number">4</div>
                                        <div>
                                            <h4 className="font-bold text-sm text-slate-700">Reportes y Respaldo</h4>
                                            <p className="text-xs text-slate-500">Use <span className="font-bold text-emerald-600">PDF PRO</span> para reportes oficiales. Use <span className="font-bold text-slate-600">Guardar Excel</span> para descargar una copia de seguridad o plantilla vacía.</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-number">5</div>
                                        <div>
                                            <h4 className="font-bold text-sm text-slate-700">Modo Cartelera</h4>
                                            <p className="text-xs text-slate-500">Active el botón <span className="font-bold text-slate-600">Cartelera</span> para una vista limpia ideal para pantallas en planta. Use 'Salir' para volver.</p>
                                        </div>
                                    </div>

                                    {/* SECCIÓN DE DEFINICIONES AGREGADA */}
                                    <div className="mt-6 pt-4 border-t border-slate-200">
                                        <h4 className="font-bold text-sm text-slate-800 mb-3 flex items-center gap-2"><Icons.Info className="h-4 w-4 text-emerald-500"/> Definiciones Clave</h4>
                                        <div className="space-y-3 text-xs text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                            <div>
                                                <strong className="text-slate-800 block">Días Perdidos:</strong>
                                                Total de días de reposo médico continuos generados por accidentes de trabajo con baja (tiempo perdido).
                                            </div>
                                            <div>
                                                <strong className="text-slate-800 block">Días Cargados:</strong>
                                                Días equivalentes asignados (penalización) según la norma por incapacidad permanente o fallecimiento.
                                            </div>
                                            <div>
                                                <strong className="text-emerald-700 block">IFN (Índice de Frecuencia Neta):</strong>
                                                Mide la cantidad de accidentes con baja por cada K horas hombre de exposición. <br/>
                                                <em>Fórmula: (Accidentes con Baja * K) / H.H.E.</em>
                                            </div>
                                            <div>
                                                <strong className="text-sky-700 block">IFB (Índice de Frecuencia Bruta):</strong>
                                                Mide el total de accidentes (con y sin baja) por cada K horas hombre de exposición. <br/>
                                                <em>Fórmula: (Total Accidentes * K) / H.H.E.</em>
                                            </div>
                                            <div>
                                                <strong className="text-red-700 block">IS (Índice de Severidad):</strong>
                                                Mide la gravedad a través de los días perdidos y cargados por cada K horas hombre. <br/>
                                                <em>Fórmula: ((Días Perdidos + Días Cargados) * K) / H.H.E.</em>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="mt-6 pt-4 border-t text-center">
                                    <button onClick={() => setShowHelpModal(false)} className="px-6 py-2 bg-indigo-500 text-white rounded-full font-bold text-sm hover:bg-indigo-600 transition-colors">¡Entendido!</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {!billboardMode && <header className="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto p-3 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4">
                                <div className="flex flex-col">
                                    <h1 className="text-2xl font-extrabold text-slate-800 tracking-tight leading-none">Gestión de Estadísticas de Accidentes</h1>
                                </div>
                            </div>
                            {/* BOTONES CON CLASE NO-PRINT PARA QUE NO SALGAN EN EL PDF */}
                            <div className="flex flex-col items-end gap-2 no-print">
                                <div className="flex gap-2">
                                    {/* Botón Ayuda */}
                                    <button onClick={() => setShowHelpModal(true)} className="header-btn btn-help-action" title="Ayuda / Instrucciones"><Icons.HelpCircle className="h-4 w-4"/> Ayuda</button>
                                    
                                    {/* Botón Reiniciar ahora abre el modal */}
                                    <button onClick={handleReset} className="header-btn btn-danger-action" title="Borrar todo"><Icons.RotateCcw className="h-4 w-4"/> Reiniciar</button>
                                    <button onClick={() => setBillboardMode(true)} className="header-btn btn-action" title="Vista limpia"><Icons.Layout className="h-4 w-4"/> Cartelera</button>
                                    <button onClick={handleDownloadPDF} className="header-btn btn-primary-action" title="Descargar Reporte"><Icons.Download className="h-4 w-4"/> PDF PRO</button>
                                    <button onClick={handleLoadDemo} className="header-btn btn-warn-action" title="Datos Prueba"><Icons.Database className="h-4 w-4"/> Cargar Demo</button><button onClick={() => setView('settings')} className="header-btn btn-action" title="Configuración"><Icons.Settings className="h-4 w-4"/> Config</button><button onClick={exportData} className="header-btn btn-action" title="Guardar Excel"><Icons.Save className="h-4 w-4"/> Guardar Excel</button><label className="header-btn btn-action cursor-pointer" title="Cargar Excel"><Icons.Upload className="h-4 w-4"/> Importar Excel <input type="file" accept=".xlsx, .xls" className="hidden" onChange={importData}/></label></div>
                                <div className="flex gap-2"><button onClick={() => { setView('input'); setEditingId(null); setFormData({...INITIAL_FORM, department: departments[0], branchId: branches[0].id}); }} className={`flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold border ${view==='input' ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'bg-white text-slate-500'}`}><Icons.Plus className="h-3 w-3"/> Cargar Mes</button><button onClick={() => setView('dashboard')} className={`flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold border ${view==='dashboard' ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'bg-white text-slate-500'}`}><Icons.BarChart3 className="h-3 w-3"/> Ver Datos</button></div>
                            </div>
                        </div>
                        <div className="h-1 w-full" style={{ backgroundColor: BRAND_COLOR }}></div>
                    </header>}

                    {billboardMode && <div className="p-6 bg-white border-b flex justify-between items-center print:hidden no-print">
                        <h1 className="text-2xl font-bold text-slate-800">Modo Cartelera</h1>
                        <div className="flex gap-2">
                            <button onClick={handleDownloadPDF} className="bg-slate-800 text-white px-4 py-2 rounded flex gap-2 items-center hover:bg-slate-700 transition-colors"><Icons.Download className="h-4 w-4"/> Descargar PDF</button>
                            <button onClick={() => setBillboardMode(false)} className="text-red-500 font-bold underline px-4 py-2">Salir</button>
                        </div>
                    </div>}

                    <main id="dashboard-content" className={`mx-auto ${billboardMode?'p-8 bg-white max-w-none':'p-6 max-w-7xl'}`}>
                         {/* Se eliminó la clase 'no-print' para que este encabezado salga en el PDF y se agregó el año */}
                         <div className="text-center py-6 mb-4">
                            <h1 className="text-3xl md:text-4xl font-extrabold uppercase tracking-tight text-slate-800 mb-2">La Movida de SST DAO Network</h1>
                            <h2 className="text-xl md:text-2xl font-bold uppercase tracking-tight" style={{ color: NEUTRAL_COLOR }}>Estadísticas de Accidentes <span style={{ color: BRAND_COLOR }}>Norma COVENIN 474</span> - {filterYear}</h2>
                            <div className="mt-4 text-xs md:text-sm text-slate-500 flex flex-col md:flex-row justify-center items-center gap-2 md:gap-6 border-t border-slate-200 pt-4 mx-auto max-w-4xl">
                               <span><Icons.User className="inline h-3 w-3 mr-1"/>Elaborado por: David Linares Brea</span>
                               <span><Icons.Globe className="inline h-3 w-3 mr-1"/>www.movidasst.com</span>
                               <span><Icons.Mail className="inline h-3 w-3 mr-1"/>movidasst@gmail.com</span>
                               <span><Icons.Phone className="inline h-3 w-3 mr-1"/>+56 9 6861 5650</span>
                            </div>
                        </div>
                         {content}
                    </main>
                </div>
            );
        }

        const SettingsOrInputView = ({ view, departments, branches, formData, handleInputChange, handleSubmit, cancelEdit, editingId, addBranch, newBranchName, setNewBranchName, newBranchState, setNewBranchState, removeBranch, addDept, newDeptName, setNewDeptName, removeDept, kValue, setKValue, records, handleEdit, handleDelete }) => {
            if (view === 'settings') return (
                <div className="max-w-4xl mx-auto animate-in fade-in space-y-6 no-print">
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><div className="flex gap-4"><label className="font-bold text-sm">Constante K</label><div className="flex gap-2"><button onClick={()=>setKValue(1000000)} className={`p-2 border rounded ${kValue===1000000?'bg-emerald-50 border-emerald-500 text-emerald-700':''}`}>1.000.000 (COVENIN)</button><button onClick={()=>setKValue(200000)} className={`p-2 border rounded ${kValue===200000?'bg-blue-50 border-blue-500 text-blue-700':''}`}>200.000 (OSHA)</button></div></div></div>
                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4"><h3 className="font-bold mb-4">Sucursales</h3><form onSubmit={addBranch} className="flex gap-2 mb-4"><input value={newBranchName} onChange={e=>setNewBranchName(e.target.value)} className="input-field flex-1" placeholder="Nombre..." /><select value={newBranchState} onChange={e=>setNewBranchState(e.target.value)} className="input-field flex-1">{VENEZUELA_STATES.map(s=><option key={s} value={s}>{s}</option>)}</select><button className="btn-primary-action header-btn">+</button></form><div className="max-h-60 overflow-y-auto space-y-2">{branches.map(b=><div key={b.id} className="flex justify-between p-2 bg-slate-50 rounded border border-slate-100 text-sm"><span>{b.name} ({b.state})</span><button onClick={()=>removeBranch(b.id)} className="text-red-400"><Icons.Trash2 className="h-4 w-4"/></button></div>)}</div></div>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4"><h3 className="font-bold mb-4">Departamentos</h3><form onSubmit={addDept} className="flex gap-2 mb-4"><input value={newDeptName} onChange={e=>setNewDeptName(e.target.value)} className="input-field flex-1" placeholder="Nombre..." /><button className="btn-primary-action header-btn">+</button></form><div className="max-h-60 overflow-y-auto space-y-2">{departments.map(d=><div key={d} className="flex justify-between p-2 bg-slate-50 rounded border border-slate-100 text-sm"><span>{d}</span><button onClick={()=>removeDept(d)} className="text-red-400"><Icons.Trash2 className="h-4 w-4"/></button></div>)}</div></div>
                    </div>
                </div>
            );
            if (view === 'input') return (
                <div className="animate-in fade-in no-print">
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        <div className="p-4 flex items-center justify-between border-b border-slate-100 bg-slate-50">
                            <h2 className="font-bold flex items-center gap-2 text-lg" style={{ color: NEUTRAL_COLOR }}>{editingId ? <><Icons.Edit2 className="h-5 w-5 text-amber-500" /> Editando</> : <><Icons.FileText className="h-5 w-5" style={{ color: BRAND_COLOR }} /> Nuevo Registro</>}</h2>
                            {editingId && <button onClick={cancelEdit} className="text-xs bg-slate-200 px-3 py-1 rounded">Cancelar</button>}
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-8">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div><label className="label-text">Sucursal</label><select name="branchId" value={formData.branchId} onChange={handleInputChange} className="input-field">{branches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></div>
                                <div><label className="label-text">Depto</label><select name="department" value={formData.department} onChange={handleInputChange} className="input-field">{departments.map(d=><option key={d} value={d}>{d}</option>)}</select></div>
                                <div className="grid grid-cols-2 gap-2"><div><label className="label-text">Mes</label><select name="month" value={formData.month} onChange={handleInputChange} className="input-field">{MONTHS.map(m=><option key={m} value={m}>{m}</option>)}</select></div><div><label className="label-text">Año</label><input type="number" name="year" value={formData.year} onChange={handleInputChange} className="input-field"/></div></div>
                                <div className="grid grid-cols-2 gap-2"><div><label className="label-text">H.H.E.</label><input type="number" name="hours" value={formData.hours} onChange={handleInputChange} className="input-field"/></div><div><label className="label-text">Trab.</label><input type="number" name="workers" value={formData.workers} onChange={handleInputChange} className="input-field"/></div></div>
                            </div>
                            <hr className="border-slate-100"/>
                            
                            <div className="grid grid-cols-1 gap-4">
                                <div className="bg-white p-4 rounded border border-emerald-200 bg-emerald-50">
                                    <div className="flex items-center gap-2 mb-2 text-xs font-bold uppercase text-emerald-700">
                                        <Icons.Briefcase className="h-4 w-4"/> Accidente de Trabajo
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div><label className="text-[10px]">Eventos</label><input type="number" name="work_acc" value={formData.work_acc} onChange={handleInputChange} className="input-field h-8 border-emerald-300" /></div>
                                        <div><label className="text-[10px]">D. Perd.</label><input type="number" name="work_daysLost" value={formData.work_daysLost} onChange={handleInputChange} className="input-field h-8 border-emerald-300" /></div>
                                        <div><label className="text-[10px]">D. Carg.</label><input type="number" name="work_daysCharged" value={formData.work_daysCharged} onChange={handleInputChange} className="input-field h-8 border-emerald-300" /></div>
                                    </div>
                                    <p className="text-[10px] text-emerald-600 mt-2 italic">
                                        * Nota: Si registra días (Perdidos o Cargados), el evento se contará automáticamente como "Con Baja" para el cálculo del IFN. Si los días son 0, se contará como "Sin Baja". ESTA NOTA TAMBIÉN APLICA PARA ITINERE, EN MISIÓN Y RECREATIVOS.
                                    </p>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-4">
                                <CategoryCard icon={Icons.Truck} title="In Itinere" accName="itinere_acc" daysLostName="itinere_daysLost" daysChargedName="itinere_daysCharged" formData={formData} onChange={handleInputChange}/>
                                <CategoryCard icon={Icons.Plane} title="En Misión" accName="mission_acc" daysLostName="mission_daysLost" daysChargedName="mission_daysCharged" formData={formData} onChange={handleInputChange}/>
                                <CategoryCard icon={Icons.PartyPopper} title="Recreativos" accName="recreation_acc" daysLostName="recreation_daysLost" daysChargedName="recreation_daysCharged" formData={formData} onChange={handleInputChange}/>
                            </div>
                            <div className="flex justify-end gap-2"><button type="submit" className="btn-primary-action header-btn px-4 py-2 rounded text-sm">Guardar</button></div>
                        </form>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50 font-bold text-sm">Registros Existentes</div>
                        <div className="overflow-x-auto max-h-60">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th className="p-2">Fecha</th>
                                        <th className="p-2">Sucursal</th>
                                        <th className="p-2">Depto</th>
                                        <th className="p-2 text-center" title="Accidentes de Trabajo">Trab.</th>
                                        <th className="p-2 text-center" title="In Itinere">Itin.</th>
                                        <th className="p-2 text-center" title="En Misión">Mis.</th>
                                        <th className="p-2 text-center" title="Recreativos">Rec.</th>
                                        <th className="p-2 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {records.slice().reverse().map(r => {
                                        const branchName = branches.find(b => b.id === r.branchId)?.name || 'N/A';
                                        return (
                                            <tr key={r.id} className="border-t hover:bg-slate-50 transition-colors">
                                                <td className="p-2 font-medium">{r.month} {r.year}</td>
                                                <td className="p-2 text-slate-600">{branchName}</td>
                                                <td className="p-2 text-slate-600">{r.department}</td>
                                                <td className="p-2 text-center font-bold text-emerald-600">{Number(r.work_acc)}</td>
                                                <td className="p-2 text-center text-slate-500">{Number(r.itinere_acc)}</td>
                                                <td className="p-2 text-center text-slate-500">{Number(r.mission_acc)}</td>
                                                <td className="p-2 text-center text-slate-500">{Number(r.recreation_acc)}</td>
                                                <td className="p-2 flex gap-2 justify-end">
                                                    <button onClick={()=>handleEdit(r)} className="text-blue-500 hover:text-blue-700 p-1"><Icons.Edit2 className="h-4 w-4"/></button>
                                                    <button onClick={()=>handleDelete(r.id)} className="text-red-500 hover:text-red-700 p-1"><Icons.Trash2 className="h-4 w-4"/></button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
            return null;
        };

        const CategoryCard = ({ icon: Icon, title, accName, daysLostName, daysChargedName, formData, onChange }) => (
            <div className="bg-white p-4 rounded border border-slate-200">
                <div className="flex items-center gap-2 mb-2 text-xs font-bold uppercase text-slate-500">
                    <Icon className="h-4 w-4"/>{title}
                </div>
                <div className="grid grid-cols-3 gap-2">
                    <div>
                        <label className="text-[10px]">Eventos</label>
                        <input type="number" name={accName} value={formData[accName]} onChange={onChange} className="input-field h-8" />
                    </div>
                    <div>
                        <label className="text-[10px]">D. Perd.</label>
                        <input type="number" name={daysLostName} value={formData[daysLostName]} onChange={onChange} className="input-field h-8" />
                    </div>
                    <div>
                        <label className="text-[10px]">D. Carg.</label>
                        <input type="number" name={daysChargedName} value={formData[daysChargedName]} onChange={onChange} className="input-field h-8" />
                    </div>
                </div>
            </div>
        );
        
        const SimpleLineChart = ({ data, dataKey1, dataKey2, color1, color2 }) => { 
           if(!data.length) return null; 
           const width = 1200; const height = 400; const padding = 40;
           const vals = data.flatMap(d => [Number(d[dataKey1])||0, Number(d[dataKey2])||0]); 
           const max = Math.max(...vals, 1) * 1.2;
           const getPoints = k => data.map((d, i) => { const x = padding + (i / (data.length - 1 || 1)) * (width - 2 * padding); const val = Number(d[k]) || 0; const y = (height - padding) - (val / max) * (height - 2 * padding); return {x, y, val: Number(d[k])||0}; });
           const l1 = getPoints(dataKey1); const l2 = getPoints(dataKey2);
           const path1 = l1.map(pt => `${pt.x},${pt.y}`).join(' '); const path2 = l2.map(pt => `${pt.x},${pt.y}`).join(' ');
           return (<svg id="chart-line-svg" viewBox={`0 0 ${width} ${height}`} className="w-full h-full" width="100%" height="100%"><rect width={width} height={height} fill="white" />{[0,0.25,0.5,0.75,1].map(k=><line key={k} x1={padding} y1={height-(height*k)-padding} x2={width-padding} y2={height-(height*k)-padding} stroke="#f1f5f9" strokeWidth="2"/>)}<polyline points={path1} fill="none" stroke={color1} strokeWidth="5" strokeLinecap="round"/><polyline points={path2} fill="none" stroke={color2} strokeWidth="3" strokeDasharray="15,10"/>{l1.map((pt,i)=><g key={i}><circle cx={pt.x} cy={pt.y} r="8" fill="white" stroke={color1} strokeWidth="4"/><rect x={pt.x-20} y={pt.y-45} width="40" height="25" rx="5" fill="white" fillOpacity="0.8"/><text x={pt.x} y={pt.y-25} fontSize="22" fontWeight="bold" fill={color1} textAnchor="middle">{pt.val>0?pt.val:''}</text></g>)}{data.map((d,i)=>{const x = padding + (i/(data.length-1||1))*(width-2*padding); return <text key={i} x={x} y={height - 10} fontSize="16" fill="#64748b" textAnchor="middle">{d.month.substring(0,3).toUpperCase()}</text>})}</svg>);
        };

        const SimpleBarChart = ({ data, dataKey, color }) => { 
           if(!data.length) return null; 
           const width = 1200; const height = 400; const padding = 40;
           const vals = data.map(d=>Number(d[dataKey])||0); const max=Math.max(...vals,1)*1.2;
           return (<svg id="chart-bar-svg" viewBox={`0 0 ${width} ${height}`} className="w-full h-full" width="100%" height="100%"><rect width={width} height={height} fill="white" />{[0,0.5,1].map(k=><line key={k} x1={padding} y1={height-padding-(height-2*padding)*k} x2={width-padding} y2={height-padding-(height-2*padding)*k} stroke="#f1f5f9" strokeWidth="2"/>)}{data.map((d,i)=>{ const val = Number(d[dataKey])||0; const bh = (val/max)*(height-2*padding); const bw = ((width-2*padding)/data.length)*0.6; const x = padding + (i * ((width-2*padding)/data.length)) + (((width-2*padding)/data.length)-bw)/2; const y = height - padding - bh; let fill = val>500 ? '#ef4444' : (val>100 ? '#f59e0b' : '#22c55e'); return <g key={i}><rect x={x} y={y} width={bw} height={bh} fill={fill} rx="4"/>{val>0 && <text x={x+bw/2} y={y-10} fontSize="20" fontWeight="bold" fill="#334155" textAnchor="middle">{val}</text>}<text x={x+bw/2} y={height - 10} fontSize="16" fill="#64748b" textAnchor="middle">{d.month.substring(0,3).toUpperCase()}</text></g>})}</svg>);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
